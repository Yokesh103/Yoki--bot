pipeline {
    agent any

    environment {
        HOST = "host.docker.internal"
        SERVICE_HEALTH_PORT = 8001
        MAX_RETRIES = 15
        RETRY_DELAY = 2
    }

    stages {

        stage('Checkout') {
            steps {
                echo "=== Checking out Git repository ==="
                git branch: 'main',
                    url: 'https://github.com/Yokesh103/Yoki--bot.git'
            }
        }

        stage('Deploy and Test Services') {
            steps {
                script {
                    try {
                        echo "=== Starting Microservices via Docker Compose (modern syntax) ==="

                        // Use modern Docker Compose v2 syntax
                        sh 'docker compose version'
                        sh 'docker compose up --build -d'
                        
                        echo "=== Waiting for greeks-service to be healthy (Max 30s) ==="
                        def maxRetries = env.MAX_RETRIES.toInteger()
                        def delay = env.RETRY_DELAY.toInteger()
                        def isReady = false

                        for (int i = 1; i <= maxRetries; i++) {
                            def status = sh(script: "curl -sf http://$HOST:$SERVICE_HEALTH_PORT/health", returnStatus: true)
                            
                            if (status == 0) {
                                echo "greeks-service is UP and healthy after ${i * delay} seconds."
                                isReady = true
                                break
                            } else {
                                echo "Attempt ${i}/${maxRetries}: Service not ready. Waiting ${delay}s..."
                                sleep(time: delay, unit: 'SECONDS')
                            }
                        }

                        if (!isReady) {
                            error "greeks-service NEVER became healthy on port ${SERVICE_HEALTH_PORT}. Stopping pipeline."
                        }

                        echo "=== Smoke Test 1: OptionChain ==="
                        sh "curl -sS -X GET 'http://$HOST:8000/optionchain?symbol=BANKNIFTY'"

                        echo "=== Smoke Test 2: Greeks (Black-76) ==="
                        sh '''
                        curl -sS -X POST "http://$HOST:8001/compute" \\
                            -H "Content-Type: application/json" \\
                            -d '{
                                "underlying": 59039,
                                "strike": 59000,
                                "option_price": 410,
                                "expiry": "2025-11-20T15:30:00",
                                "option_type": "CE",
                                "model": "black76"
                              }'
                        '''

                        echo "=== Smoke Test 3: Signal ==="
                        sh "curl -sS -X GET 'http://$HOST:8002/signal?strategy=butterfly&symbol=BANKNIFTY'"

                        echo "=== Smoke Test 4: OrderManager ==="
                        sh '''
                        curl -sS -X POST "http://$HOST:8003/createOrder" \\
                        -H "Content-Type: application/json" \\
                        -d '{"symbol":"BANKNIFTY","strategy":"butterfly","legs":[]}'
                        '''

                        echo "=== Smoke Test 5: PaperExec ==="
                        sh '''
                        curl -sS -X POST "http://$HOST:8004/exec" \\
                        -H "Content-Type: application/json" \\
                        -d '{"order_id":"test-1","legs":[],"qty":25}'
                        '''

                    } finally {
                        echo "=== Tearing down services (docker compose down) ==="
                        sh 'docker compose down'
                    }
                }
            }
        }

        stage('Push to Registry') {
            when { expression { false } }
            steps {
                echo "Push to registry disabled."
            }
        }
    }

    post {
        success {
            echo "Pipeline SUCCESS — All services healthy and responding."
        }
        failure {
            echo "Pipeline FAILED — One or more smoke tests failed or services did not start."
        }
    }
}
